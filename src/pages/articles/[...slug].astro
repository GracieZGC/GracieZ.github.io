---
import BaseLayout from "../../layouts/BaseLayout.astro";
import TagPill from "../../components/TagPill.astro";
import TocSidebar from "../../components/TocSidebar.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
	const entries = await getCollection("guides", (e) => !e.data.draft);
	return entries.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();

const related = (await getCollection("guides", (e) => !e.data.draft && e.slug !== entry.slug))
	.filter((e) => e.data.tags.some((t) => entry.data.tags.includes(t)))
	.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
	.slice(0, 4);
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
	<section class="page">
		<div class="container">
			<div class="layout">
				<TocSidebar headings={headings} />

				<div class="stack main">
					<article class="card-pad">
						<header class="head">
							<h1 class="title">
								<svg
									class="titleIcon"
									viewBox="0 0 1024 1024"
									version="1.1"
									xmlns="http://www.w3.org/2000/svg"
									aria-hidden="true"
									focusable="false"
								>
									<path d="M0 0H307.2v1024H0z" fill="currentColor"></path>
								</svg>
								{entry.data.title}
							</h1>
							<div class="section-underline" aria-hidden="true"></div>
							<div class="meta">
								<span class="muted">{entry.data.pubDate.toISOString().slice(0, 10)}</span>
								<span class="muted">·</span>
								<a class="muted" href="/articles">返回列表</a>
							</div>
							{entry.data.description ? <p class="muted">{entry.data.description}</p> : null}
							{entry.data.diagram ? (
								<div class="diagram">
									<img src={entry.data.diagram} alt={entry.data.diagramAlt ?? entry.data.title} loading="lazy" />
								</div>
							) : null}
							{entry.data.tags.length ? (
								<div class="tagRow">
									{entry.data.tags.map((t) => (
										<TagPill tag={t} href={`/articles#tag=${encodeURIComponent(t)}`} />
									))}
								</div>
							) : null}
						</header>

						<div class="content">
							<Content />
						</div>
					</article>

					{related.length ? (
						<section class="card-pad">
							<h2 class="section-title">相关文章</h2>
							<ul class="rel">
								{related.map((e) => (
									<li>
										<a href={`/articles/${e.slug}`}>{e.data.title}</a>
									</li>
								))}
							</ul>
						</section>
					) : null}
				</div>
			</div>
		</div>
	</section>

	<style>
		.page {
			padding: 28px 0 60px;
		}
		.layout {
			display: grid;
			grid-template-columns: 280px minmax(0, 1fr);
			gap: 28px;
			align-items: start;
		}
		.main {
			min-width: 0;
		}
		.title {
			margin: 0;
			font-size: 30px;
			font-weight: 800;
			letter-spacing: 0.02em;
			line-height: 1.25;
			display: inline-flex;
			align-items: center;
			gap: 10px;
		}
		.titleIcon {
			width: 10px;
			height: 18px;
			color: var(--accent);
		}
		.meta {
			margin-top: 10px;
			display: flex;
			gap: 10px;
			align-items: center;
			flex-wrap: wrap;
		}
		.tagRow {
			margin-top: 12px;
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}
		.diagram {
			margin-top: 16px;
		}
		.diagram img {
			display: block;
			max-width: 100%;
			height: auto;
			border-radius: 16px;
		}
		.content :global(img) {
			max-width: 100%;
			height: auto;
		}
		.rel {
			margin: 10px 0 0;
			padding-left: 18px;
		}
		@media (max-width: 980px) {
			.layout {
				grid-template-columns: 1fr;
			}
		}
	</style>
</BaseLayout>

