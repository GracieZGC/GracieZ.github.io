---
import BaseLayout from "../../layouts/BaseLayout.astro";
import TagPill from "../../components/TagPill.astro";
import TocSidebar from "../../components/TocSidebar.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
	const entries = await getCollection("guides", (e) => !e.data.draft);
	return entries.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();

const HIDDEN_TAGS = new Set(["IntangibleHeritage", "AIGC", "PromptEngineering", "Workflow"]);
const normalizeTag = (tag) => String(tag || "").trim().replace(/^#/, "");
const displayTags = (entry.data.tags || []).filter((t) => !HIDDEN_TAGS.has(normalizeTag(t)));

const related = (await getCollection("guides", (e) => !e.data.draft && e.slug !== entry.slug))
	.filter((e) => e.data.tags.some((t) => displayTags.includes(t)))
	.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
	.slice(0, 4);
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
	<section class="page">
		<div class="container">
			<div class="layout">
				<TocSidebar headings={headings} />

				<div class="stack main">
					<article class="card-pad">
						<header class="head">
							<h1 class="title">{entry.data.title}</h1>
							<div class="meta">
								<span class="muted">{entry.data.pubDate.toISOString().slice(0, 10)}</span>
								<span class="muted">·</span>
								<a class="muted" href="/articles">返回列表</a>
							</div>
							{entry.data.description ? <p class="muted">{entry.data.description}</p> : null}
							{entry.data.diagram ? (
								<div class="diagram">
									<img src={entry.data.diagram} alt={entry.data.diagramAlt ?? entry.data.title} loading="lazy" />
								</div>
							) : null}
							{displayTags.length ? (
								<div class="tagRow">
									{displayTags.map((t) => (
										<TagPill tag={t} href={`/articles#tag=${encodeURIComponent(t)}`} />
									))}
								</div>
							) : null}
						</header>

						<div class="content">
							<Content />
						</div>
					</article>

					{related.length ? (
						<section class="card-pad">
							<h2 class="section-title">相关文章</h2>
							<ul class="rel">
								{related.map((e) => (
									<li>
										<a href={`/articles/${e.slug}`}>{e.data.title}</a>
									</li>
								))}
							</ul>
						</section>
					) : null}
				</div>
			</div>
		</div>
	</section>

	<style>
		.page {
			padding: 28px 0 60px;
		}
		.layout {
			display: grid;
			grid-template-columns: 280px minmax(0, 1fr);
			gap: 28px;
			align-items: start;
		}
		.main {
			min-width: 0;
		}
		.title {
			margin: 0;
			font-size: 30px;
			font-weight: 800;
			letter-spacing: 0.02em;
			line-height: 1.25;
		}
		.meta {
			margin-top: 10px;
			display: flex;
			gap: 10px;
			align-items: center;
			flex-wrap: wrap;
		}
		.tagRow {
			margin-top: 12px;
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}
		.diagram {
			margin-top: 16px;
		}
		.diagram img {
			display: block;
			max-width: 100%;
			height: auto;
			border-radius: 16px;
		}
		.content :global(img) {
			max-width: 100%;
			height: auto;
		}
		.rel {
			margin: 10px 0 0;
			padding-left: 18px;
		}
		@media (max-width: 980px) {
			.layout {
				grid-template-columns: 1fr;
			}
		}
	</style>
</BaseLayout>
